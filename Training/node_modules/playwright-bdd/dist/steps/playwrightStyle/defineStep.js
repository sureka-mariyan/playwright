"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getStepCode = exports.buildCucumberStepFn = exports.defineStep = void 0;
const cucumber_1 = require("@cucumber/cucumber");
const exit_1 = require("../../utils/exit");
const autoInject_1 = require("../../run/bddFixtures/autoInject");
/**
 * Defines step by config.
 * Calls cucumber's Given(), When(), Then() under the hood.
 */
function defineStep(stepConfig) {
    const { keyword, pattern } = stepConfig;
    const cucumberDefineStep = getCucumberDefineStepFn(keyword);
    const code = buildCucumberStepFn(stepConfig);
    try {
        cucumberDefineStep(pattern, code);
    }
    catch (e) {
        // todo: detect that this is import from test file
        // and skip/delay registering cucumber steps until cucumber is loaded
        const isMissingCucumber = /Cucumber that isn't running/i.test(e.message);
        if (isMissingCucumber) {
            (0, exit_1.exit)(`Option "importTestFrom" should point to a separate file without step definitions`, `(e.g. without calls of Given, When, Then)`);
        }
        else {
            throw e;
        }
    }
}
exports.defineStep = defineStep;
function buildCucumberStepFn(stepConfig) {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const code = function (...args) {
        // build the first argument (fixtures) for step fn
        const fixturesArg = Object.assign({}, this.$internal.currentStepFixtures, (0, autoInject_1.getBddAutoInjectFixtures)(this));
        return stepConfig.fn.call(this, fixturesArg, ...args);
    };
    // attach stepConfig to fn for easier access later
    code.stepConfig = stepConfig;
    return code;
}
exports.buildCucumberStepFn = buildCucumberStepFn;
function getStepCode(stepDefinition) {
    return stepDefinition.code;
}
exports.getStepCode = getStepCode;
function getCucumberDefineStepFn(keyword) {
    switch (keyword) {
        case 'Given':
            return cucumber_1.Given;
        case 'When':
            return cucumber_1.When;
        case 'Then':
            return cucumber_1.Then;
        default:
            return cucumber_1.defineStep;
    }
}
//# sourceMappingURL=defineStep.js.map