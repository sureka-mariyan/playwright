{"version":3,"file":"StaticAllureContextProvider.js","names":["AllureContextProviderBase","MutableAllureContext","constructor","_defineProperty","Map","last","scopeStack","currentFixture","currentTest","scope","stepStacks","get","arr","_arr","length","MutableAllureContextHolder","context","uuid","push","pop","removeAllOccurrences","steps","set","delete","val","i","indexOf","splice","StaticContextProvider","holderSingleton","holder","Object","is","Error","_StaticContextProvider"],"sources":["../../../../../src/sdk/reporter/context/StaticAllureContextProvider.ts"],"sourcesContent":["import { AllureContextProviderBase } from \"./AllureContextProviderBase.js\";\nimport type { AllureContext, AllureContextHolder } from \"./types.js\";\n\n/**\n * Allure context that stores its data in mutable class fields.\n * Unsafe from the cuncurrency standpoint.\n */\nexport class MutableAllureContext implements AllureContext {\n  readonly scopeStack: string[] = [];\n  currentFixture: string | null = null;\n  currentTest: string | null = null;\n  readonly stepStacks: Map<string, string[]> = new Map();\n\n  getScope = () => MutableAllureContext.last(this.scopeStack);\n  getFixture = () => this.currentFixture;\n  getTest = () => this.currentTest;\n  getStep = (scope: string) => MutableAllureContext.last(this.stepStacks.get(scope));\n\n  private static last = <T>(arr: T[] | undefined) => arr?.[arr.length - 1] ?? null;\n}\n\n/**\n * Implements transitioning between context values by mutating the context\n * object.\n * Unsafe from the cuncurrency standpoint.\n */\nexport class MutableAllureContextHolder implements AllureContextHolder<MutableAllureContext> {\n  private readonly context: MutableAllureContext = new MutableAllureContext();\n\n  get = () => this.context;\n\n  addScope = (uuid: string) => {\n    this.context.scopeStack.push(uuid);\n  };\n\n  removeScope = () => {\n    this.context.scopeStack.pop();\n  };\n\n  removeScopeByUuid = (uuid: string) => MutableAllureContextHolder.removeAllOccurrences(this.context.scopeStack, uuid);\n\n  setFixture = (uuid: string) => {\n    this.context.currentFixture = uuid;\n  };\n\n  removeFixture = () => {\n    this.context.currentFixture = null;\n  };\n\n  setTest = (uuid: string) => {\n    this.context.currentTest = uuid;\n  };\n\n  removeTest = () => {\n    this.context.currentTest = null;\n  };\n\n  addStep = (scope: string, uuid: string) => {\n    const steps = this.context.stepStacks.get(scope);\n    if (steps) {\n      steps.push(uuid);\n    } else {\n      this.context.stepStacks.set(scope, [uuid]);\n    }\n  };\n\n  removeStep = (scope: string) => {\n    const steps = this.context.stepStacks.get(scope);\n    if (steps) {\n      steps.pop();\n      if (!steps.length) {\n        this.context.stepStacks.delete(scope);\n      }\n    }\n  };\n\n  removeStepByUuid = (scope: string, uuid: string) => {\n    const steps = this.context.stepStacks.get(scope);\n    if (steps) {\n      MutableAllureContextHolder.removeAllOccurrences(steps, uuid);\n      if (!steps.length) {\n        this.context.stepStacks.delete(scope);\n      }\n    }\n  };\n\n  private static removeAllOccurrences<T>(arr: T[], val: T) {\n    for (let i = arr.indexOf(val); i !== -1; i = arr.indexOf(val, i)) {\n      arr.splice(i, 1);\n    }\n  }\n}\n\n/**\n * Stores the context in a class field. That's a simple but not async-safe way of\n * manipulating the context.\n */\nexport class StaticContextProvider<\n  TContext extends AllureContext,\n  THolder extends AllureContextHolder<TContext>,\n> extends AllureContextProviderBase<TContext, THolder> {\n  constructor(private readonly holderSingleton: THolder) {\n    super();\n  }\n\n  protected override load = () => this.holderSingleton;\n\n  /* The changes are already persisted in the holder singleton. */\n  protected store = (holder: THolder) => {\n    if (!Object.is(holder, this.holderSingleton)) {\n      throw new Error(\"The static context holder can'be replaced with another one.\");\n    }\n  };\n\n  /**\n   * Wraps a context holder singleton in the static context provider.\n   * @param holderSingleton The singleton to wrap.\n   */\n  // eslint-disable-next-line @typescript-eslint/no-shadow\n  static wrap = <TContext extends AllureContext, THolder extends AllureContextHolder<TContext>>(\n    holderSingleton: THolder,\n  ) => new StaticContextProvider<TContext, THolder>(holderSingleton);\n}\n"],"mappings":"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","ignoreList":[]}